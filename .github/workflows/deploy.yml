name: Deploy to Linode and Docker Hub

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install Linode CLI
        run: pip install linode-cli
      
      - name: Verify Linode CLI Installation
        run: linode-cli --version
      
      - name: Configure Linode CLI
        env:
          LINODE_CLI_TOKEN: ${{ secrets.LINODE_CLI_TOKEN }}
        run: |
          export LINODE_CLI_TOKEN
          linode-cli --no-defaults linodes list
          
      - name: Set up SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.LINODE_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.LINODE_INSTANCE_IP }} >> ~/.ssh/known_hosts

      - name: Set Environment Variables
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "APP_ENV=prod" >> $GITHUB_ENV
            echo "APP_SERVICE=prod_app" >> $GITHUB_ENV
            echo "DOCKER_TAG=prod" >> $GITHUB_ENV
            echo "APP_DIR=/root/node_app_prod" >> $GITHUB_ENV
            echo "COMPOSE_FILE=docker-compose.yaml" >> $GITHUB_ENV
          else
            echo "APP_ENV=dev" >> $GITHUB_ENV
            echo "APP_SERVICE=dev_app" >> $GITHUB_ENV
            echo "DOCKER_TAG=dev" >> $GITHUB_ENV
            echo "APP_DIR=/root/node_app_dev" >> $GITHUB_ENV
            echo "COMPOSE_FILE=docker-compose.yaml" >> $GITHUB_ENV
          fi

      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Build and push Docker image
        env:
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
        run: |
          docker build -t $DOCKER_HUB_USERNAME/app:${{ env.DOCKER_TAG }} .
          docker push $DOCKER_HUB_USERNAME/app:${{ env.DOCKER_TAG }}

      - name: Verify Docker Hub Push
        env:
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
        run: |
          MANIFEST=$(docker manifest inspect $DOCKER_HUB_USERNAME/app:${{ env.DOCKER_TAG }})
          if [ $? -eq 0 ]; then
            echo "Image successfully pushed and verified on Docker Hub"
          else
            echo "Failed to verify image on Docker Hub"
            exit 1
          fi

      - name: Deploy to Linode
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true)
        env:
          LINODE_INSTANCE_IP: ${{ secrets.LINODE_INSTANCE_IP }}
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
        run: |
          ssh root@$LINODE_INSTANCE_IP "
            # 確保目標目錄存在
            mkdir -p ${{ env.APP_DIR }}

            # 克隆最新的程式碼到臨時目錄
            git clone --depth 1 --branch ${{ github.ref_name }} https://github.com/${{ github.repository }}.git ${{ env.APP_DIR }}_tmp

            # 如果 .env 文件不存在，則從適當的範本創建它
            if [ ! -f ${{ env.APP_DIR }}/.env ]; then
              if [ '${{ github.ref }}' = 'refs/heads/main' ]; then
                cp ${{ env.APP_DIR }}_tmp/.env.prod_temp ${{ env.APP_DIR }}/.env.prod
              else
                cp ${{ env.APP_DIR }}_tmp/.env.dev_temp ${{ env.APP_DIR }}/.env.dev
              fi
            fi

            # 使用 rsync 更新文件，排除 .env
            rsync -av --delete --exclude='.env' ${{ env.APP_DIR }}_tmp/ ${{ env.APP_DIR }}/
            
            # 清理臨時目錄
            rm -rf ${{ env.APP_DIR }}_tmp
            
            # 切換到應用程式目錄
            cd ${{ env.APP_DIR }}

            # 拉取最新的 Docker 映像
            docker-compose -f ${{ env.COMPOSE_FILE }} pull

            # 停止舊的容器
            docker-compose -f ${{ env.COMPOSE_FILE }} down --remove-orphans

            # 啟動新的容器
            docker-compose -f ${{ env.COMPOSE_FILE }} up -d --build ${{ env.APP_SERVICE }} mongo redis nginx

            # 清理未使用的 Docker 資源
            docker system prune -af
          "

      - name: Verify Deployment
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true)
        env:
          LINODE_INSTANCE_IP: ${{ secrets.LINODE_INSTANCE_IP }}
        run: |
          ssh root@$LINODE_INSTANCE_IP "
            cd ${{ env.APP_DIR }} &&
            docker ps &&
            docker-compose -f ${{ env.COMPOSE_FILE }} logs --tail=50 ${{ env.APP_SERVICE }} nginx
          "